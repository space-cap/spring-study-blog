<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default}">
<head>
    <title>예약 관리</title>
</head>
<body>
<section layout:fragment="content" class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>예약 관리 목록</h1>
        <a th:href="@{/admin/appointments/new}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> 신규 예약 등록
        </a>
    </div>

    <!-- 검색 필터 폼 -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form id="filterForm" th:action="@{/admin/appointments}" method="get" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="customerName" class="form-label">고객 이름</label>
                    <input type="text" id="customerName" name="customerName" class="form-control">
                </div>
                <div class="col-md-2">
                    <label for="status" class="form-label">예약 상태</label>
                    <select id="status" name="status" class="form-select">
                        <option value="">전체</option>
                        <option value="예약완료">예약완료</option>
                        <option value="진료완료">진료완료</option>
                        <option value="예약취소">예약취소</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="startDate" class="form-label">시작일</label>
                    <input type="date" id="startDate" name="startDate" class="form-control">
                </div>
                <div class="col-md-3">
                    <label for="endDate" class="form-label">종료일</label>
                    <input type="date" id="endDate" name="endDate" class="form-control">
                </div>
                <div class="col-md-1">
                    <button type="submit" class="btn btn-success w-100">검색</button>
                </div>
            </form>
            <div class="mt-3">
                <button type="button" class="btn btn-sm btn-outline-secondary date-btn" data-period="today">오늘</button>
                <button type="button" class="btn btn-sm btn-outline-secondary date-btn" data-period="week">1주일</button>
                <button type="button" class="btn btn-sm btn-outline-secondary date-btn" data-period="month">1개월</button>
                <button type="button" class="btn btn-sm btn-outline-danger" id="resetBtn">초기화</button>
            </div>
        </div>
    </div>

    <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
    <div class="card shadow-sm">
        <div class="card-body">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                <tr>
                    <th>
                        <a th:href="@{/admin/appointments(sortField='appointmentDatetime', sortDir=${sortField == 'appointmentDatetime' ? reverseSortDir : 'asc'}, status=${status}, customerName=${customerName}, startDate=${startDate}, endDate=${endDate})}">
                            예약일시
                            <i th:if="${sortField == 'appointmentDatetime'}" th:class="${sortDir == 'asc' ? 'bi bi-arrow-up' : 'bi bi-arrow-down'}"></i>
                        </a>
                    </th>
                    <th>
                        <a th:href="@{/admin/appointments(sortField='customer.name', sortDir=${sortField == 'customer.name' ? reverseSortDir : 'asc'}, status=${status}, customerName=${customerName}, startDate=${startDate}, endDate=${endDate})}">
                            고객명
                            <i th:if="${sortField == 'customer.name'}" th:class="${sortDir == 'asc' ? 'bi bi-arrow-up' : 'bi bi-arrow-down'}"></i>
                        </a>
                    </th>
                    <th>담당의</th>
                    <th>상태</th>
                    <th>관리</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="app : ${appointmentPage.content}">
                    <td th:text="${#temporals.format(app.appointmentDatetime, 'yyyy-MM-dd HH:mm')}"></td>
                    <td th:text="${app.customer.name}"></td>
                    <td th:text="${app.doctor.name}"></td>
                    <td><span class="badge" th:classappend="${app.status == '예약완료'} ? 'bg-success' : (${app.status == '진료완료'} ? 'bg-secondary' : 'bg-danger')" th:text="${app.status}"></span></td>
                    <td>
                        <a th:href="@{/admin/appointments/edit/{id}(id=${app.appointment_id})}" class="btn btn-sm btn-outline-secondary">수정</a>
                    </td>
                </tr>
                <tr th:if="${appointmentPage.isEmpty()}">
                    <td colspan="5" class="text-center text-muted py-4">검색 결과가 없습니다.</td>
                </tr>
                </tbody>
            </table>

            <!-- [수정] 스마트 페이지네이션 바 -->
            <nav th:if="${appointmentPage.totalPages > 1}" aria-label="Page navigation">
                <ul class="pagination justify-content-center">
                    <!-- 처음으로 -->
                    <li class="page-item" th:classappend="${appointmentPage.first} ? 'disabled'">
                        <a class="page-link" th:href="@{/admin/appointments(page=0, status=${status}, customerName=${customerName}, startDate=${startDate}, endDate=${endDate}, sortField=${sortField}, sortDir=${sortDir})}">
                            <span>&laquo;&laquo;</span>
                        </a>
                    </li>
                    <!-- 이전 페이지 -->
                    <li class="page-item" th:classappend="${appointmentPage.first} ? 'disabled'">
                        <a class="page-link" th:href="@{/admin/appointments(page=${appointmentPage.number - 1}, status=${status}, customerName=${customerName}, startDate=${startDate}, endDate=${endDate}, sortField=${sortField}, sortDir=${sortDir})}">
                            <span>&laquo;</span>
                        </a>
                    </li>
                    <!-- 페이지 번호들 -->
                    <li class="page-item" th:each="pageNumber : ${#numbers.sequence(startPage, endPage)}" th:classappend="${pageNumber == appointmentPage.number} ? 'active'">
                        <a class="page-link" th:href="@{/admin/appointments(page=${pageNumber}, status=${status}, customerName=${customerName}, startDate=${startDate}, endDate=${endDate}, sortField=${sortField}, sortDir=${sortDir})}" th:text="${pageNumber + 1}"></a>
                    </li>
                    <!-- 다음 페이지 -->
                    <li class="page-item" th:classappend="${appointmentPage.last} ? 'disabled'">
                        <a class="page-link" th:href="@{/admin/appointments(page=${appointmentPage.number + 1}, status=${status}, customerName=${customerName}, startDate=${startDate}, endDate=${endDate}, sortField=${sortField}, sortDir=${sortDir})}">
                            <span>&raquo;</span>
                        </a>
                    </li>
                    <!-- 마지막으로 -->
                    <li class="page-item" th:classappend="${appointmentPage.last} ? 'disabled'">
                        <a class="page-link" th:href="@{/admin/appointments(page=${appointmentPage.totalPages - 1}, status=${status}, customerName=${customerName}, startDate=${startDate}, endDate=${endDate}, sortField=${sortField}, sortDir=${sortDir})}">
                            <span>&raquo;&raquo;</span>
                        </a>
                    </li>
                </ul>
            </nav>

        </div>
    </div>
</section>

<th:block layout:fragment="script">
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('filterForm');
            const filterKeys = ['status', 'customerName', 'startDate', 'endDate'];
            const params = new URLSearchParams(window.location.search);

            // 1. URL 파라미터가 있으면 세션 스토리지에 저장
            if (params.has('status') || params.has('customerName') || params.has('startDate') || params.has('endDate')) {
                filterKeys.forEach(key => {
                    const value = params.get(key);
                    if (value) {
                        sessionStorage.setItem('appointmentFilter.' + key, value);
                    } else {
                        sessionStorage.removeItem('appointmentFilter.' + key);
                    }
                });
            }
            // 2. URL 파라미터가 없으면, 세션 스토리지 값으로 리다이렉트 (페이지 첫 로드 시)
            else if (window.location.search === "") {
                const storedParams = new URLSearchParams();
                let hasStoredFilters = false;
                filterKeys.forEach(key => {
                    const value = sessionStorage.getItem('appointmentFilter.' + key);
                    if (value) {
                        storedParams.append(key, value);
                        hasStoredFilters = true;
                    }
                });

                if (hasStoredFilters) {
                    window.location.href = window.location.pathname + '?' + storedParams.toString();
                    return;
                }
            }

            // 3. 현재 필터 값으로 폼 필드 채우기
            filterKeys.forEach(key => {
                const value = sessionStorage.getItem('appointmentFilter.' + key);
                const input = form.querySelector(`[name=${key}]`);
                if (input && value) {
                    input.value = value;
                }
            });

            // 4. 검색 시 세션 스토리지 업데이트
            form.addEventListener('submit', function() {
                filterKeys.forEach(key => {
                    const input = form.querySelector(`[name=${key}]`);
                    if (input && input.value) {
                        sessionStorage.setItem('appointmentFilter.' + key, input.value);
                    } else {
                        sessionStorage.removeItem('appointmentFilter.' + key);
                    }
                });
            });

            // --- [신규 추가] 기간 설정 버튼 스크립트 ---
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');

            document.querySelectorAll('.date-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const period = this.dataset.period;
                    const today = new Date();
                    let startDate = new Date();
                    let endDate = new Date();

                    if (period === 'today') {
                        // startDate와 endDate 모두 오늘
                    } else if (period === 'week') {
                        endDate.setDate(today.getDate() + 7);
                    } else if (period === 'month') {
                        endDate.setMonth(today.getMonth() + 1);
                    }

                    // yyyy-MM-dd 형식으로 변환
                    const formatDate = (date) => date.toISOString().split('T')[0];

                    startDateInput.value = formatDate(startDate);
                    endDateInput.value = formatDate(endDate);
                    form.requestSubmit(); // form 제출
                });
            });

            // 초기화 버튼
            document.getElementById('resetBtn').addEventListener('click', function() {
                filterKeys.forEach(key => {
                    const input = form.querySelector(`[name=${key}]`);
                    if(input) input.value = '';
                    sessionStorage.removeItem('appointmentFilter.' + key);
                });
                window.location.href = window.location.pathname; // 파라미터 없이 페이지 리로드
            });
        });
    </script>
</th:block>
</body>
</html>
